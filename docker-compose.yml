services: # define los contenedores que vamos a levantar

  frontend: # Nombre del contenedor

    build:  # Indica como construir la imagen del contenedor
      context: ./frontend # Carpeta donde se buscara el Dockerfile y el codigo fuente
      dockerfile: Dockerfile.dev #  Dockerfile para dev
  
    ports:  # Mapea los puertos del contenedor al host
      - "5173:5173" # El contenedor expone vite en el puerto 5173 y as√≠ podemos acceder a el navegador de la maquina host
  
    volumes: #  Monta carpetas entre el host y el contenedor.
      - ./frontend:/app  # montamos el codigo en el contenedor
      - /app/node_modules # para que no se sobre escriban las dependencias
  
    environment:  # Define variables de entorno dentro del contenedor. 
      - NODE_ENV=development  # Indica que estamos en modo de desarrollo
      - CHOKIDAR_USEPOLLING=true  # Activa el polling para que vite detecte cambios en windows/docker correctamente.
      - CHOKIDAR_INTERVAL=100 # Define cuanto tiempo en ms CHOKIDAR revisa los cambios en los archivos.

    
  backend:  # Nombre del contenedor
    build:  # Indica como contruir la imagen del contenedor
      context: ./backend  # Carpeta donde se buscara el Dockerfile y el codigo fuente
      dockerfile: Dockerfile.dev  # Dockerfile para dev
    ports:
      - "8000:8000" # Expone el puerto 8000 del contenedor al puerto 8000 de la maquina local permitiendo acceder a django desde el navegador
    volumes:
      - ./backend:/app  # Sincroniza la carpeta local ./backend con la carpeta /app dentro del contenedor.
    environment: #  define variables de entorno dentro del contenedor
      # Variables para conectar Django con PostgreSQL
      - DATABASE_URL=postgresql://7ffc2948f66e8a33be69b47a5b8996f8:507aa218f8588f1a7abbac9651a94f8a@db:5432/EMBARKIDS1.2.1
      - DB_NAME=EMBARKIDS1.2.1
      - DB_USER=7ffc2948f66e8a33be69b47a5b8996f8
      - DB_PASSWORD=507aa218f8588f1a7abbac9651a94f8a
      - DB_HOST=db
      - DB_PORT=5432
      - SECRET_KEY=CARLOSM404
      - DEBUG=True
    depends_on:
      db:
        condition: service_healthy


  db: 
    image: postgres:15 #  Usa la imagen oficial de PostgreSQL version 15 como base para el contenedor de la base de datos
    environment: #  define variables de entorno dentro del contenedor
      POSTGRES_DB: EMBARKIDS1.2.1
      POSTGRES_USER: 7ffc2948f66e8a33be69b47a5b8996f8
      POSTGRES_PASSWORD: 507aa218f8588f1a7abbac9651a94f8a
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U 7ffc2948f66e8a33be69b47a5b8996f8 -d EMBARKIDS1.2.1"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  pgdata: